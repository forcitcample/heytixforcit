/*!
 * Screets Chat X plugin (for 1.8/9+)
 * Author: @screetscom
 *
 * COPYRIGHT (c) 2014 Screets. All rights reserved.
 * This  is  commercial  software,  only  users  who have purchased a valid
 * license  and  accept  to the terms of the  License Agreement can install
 * and use this program.
 */
(function(d,p,q,w){function s(){this.opts=d.extend({},v)}var v={app_id:"",render:!0,display_login:!0,disable_on_mobile:!1,notify_by_email:!1,btn_view:{show_title:!0,show_icon:!1,show_arrow:!1},users_list_id:"#CX_users",gravity:"n",popup_width:240,btn_width:180,anim:"bounceInUp",speed_up:!1,delay:0,radius:"5px",trim_radius:!1,offset_x:"40px",offset_y:"0",company_avatar:"",avatar_size:40,reply_pos:"top",guest_prefix:"Guest-",offline_redirect:"",user_info:{id:null,name:null,email:null,phone:null},debug:!1,
offline_form:{name:{title:"Your name",type:"text",req:!0,val:""},email:{title:"E-mail",type:"email",req:!0,val:""},question:{title:"Got a question?",type:"textarea",req:!0,val:""}},login_form:{name:{title:"Your name",type:"text",req:!1,val:""},email:{title:"E-mail",type:"email",req:!0,val:""}},colors:{primary:"#e54440",link:"#459ac4"},msg:{online:"Talk to us",offline:"Contact us",prechat_msg:"Questions? We're here. Send us a message!",welc_msg:"Questions, issues or concerns? I'd love to help you!",
start_chat:"Start Chat",offline_body:"Sorry! We're not around right now. Leave a message using the form below and we'll get back to you, asap.",reply_ph:"Type here and hit enter to chat",send_btn:"Send",no_op:"No operators online",no_msg:"No messages found",sending:"Sending",connecting:"Connecting",writing:"%s is writing",please_wait:"Please wait",chat_online:"Chat Online",chat_offline:"Chat Offline",optional:"Optional",your_msg:"Your message",end_chat:"End chat",conn_err:"Connecting error!",you:"You",
online_btn:"Online",offline_btn:"Offline",field_empty:"Please fill out all required fields",invalid_email:"E-mail is invalid",op_not_allowed:"Operators do not chat from here, only visitors. If you want to test chat box, you will want to use two different browsers or computers",months:"January February March April May June July August September October November December".split(" "),months_short:"Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec".split(" "),time:{suffix:"ago",seconds:"less than a minute",
minute:"about a minute",minutes:"%d minutes",hour:"about an hour",hours:"about %d hours",day:"a day",days:"%d days",month:"about a month",months:"%d months",year:"about a year",years:"%d years"}},before_load:d.noop,after_load:d.noop,on_connect:d.noop,on_disconnect:d.noop,auth:d.noop,auth_error:d.noop,logged_in:d.noop,logged_out:d.noop,offline:d.noop,new_msg:d.noop,user_online:d.noop,user_offline:d.noop,user_created:d.noop,user_failed:d.noop,cnv_msgs_loaded:d.noop};s.prototype={init:function(a){d.extend(this.opts,
a);this.data={ref:null,auth:null,mode:"offline",logged:!1,active_user_id:0,is_mobile:!1,anim_delay:0,primary_fg:null,primary_hover:null,link_hover:null,v_pos:null,h_pos:null,radius:null,radius_f:null,radius_h:null,box_id:0,popup_status:"close",user:{},current_form:{},online_ops:{},entity_map:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"}};this.objs={btn:null,popup:null,popup_header:null,cnv:null};if(!1!==this.trigger("before_load")){var b=this;/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&
(this.data.is_mobile=!0);this.opts.anim&&(this.data.anim_delay=this.opts.speed_up?400:1E3);this.post("get_token",{},function(a){a.error||(b.data.auth_token=a.token,b.log(a.token),b.run(),cx.is_op&&!cx.is_front_end&&b.auth())})}},run:function(){this.render_btn();this.render_popup();d(".cx-open-chatbox").click(function(a){self.opts.render=1;self.objs.btn.trigger("click");return!1});this.check_ntf()},auth:function(a){var b=this;this.opts.app_id?(this.data.ref=new Firebase("https://"+this.opts.app_id+
".firebaseIO.com"),this.data.ref_conn=new Firebase("http://"+b.opts.app_id+".firebaseIO.com/.info/connected"),this.data.ref_cnv=new Firebase("http://"+this.opts.app_id+".firebaseIO.com/conversations"),this.data.ref_msgs=new Firebase("http://"+this.opts.app_id+".firebaseIO.com/messages"),this.data.ref_users=new Firebase("http://"+this.opts.app_id+".firebaseIO.com/users"),this.data.ref.child(".info/connected").on("value",function(a){!0===a.val()?(b.log("Firebase connnected"),b.trigger("on_connect")):
(b.log("Firebase disconnected"),b.trigger("on_disconnect"))}),this.opts.display_login?this.login(!1,!0,a):this.login(!0,!0,a),this.trigger("after_load")):console.error("App ID isn't provided")},login:function(a,b,c){var e=this;this.manage_conn();this.data._new_user=a;this.data.auth=this.data.ref.auth(this.data.auth_token,function(a){a?(console.error(a.code,a.message),e.trigger("auth_error",a),e.display_ntf(e.opts.conn_err,"error")):(e.trigger("auth"),e.data.logged=!0,e.data.ref_users.once("value",
function(a){a=a.val();var b=0;if(null!==a){var m=Object.keys(a).length;d.each(a,function(a,c){b+=1;c&&"operator"==c.type&&"online"===c.status&&(e.data.online_ops[c.id]=c);b===m&&(e.total_online_ops()?e.opts.display_login?e.show_login():e.show_cnv(!0):e.show_offline(),e.check_user(e.opts.user_info.id))})}else e.show_offline(),e.check_user(e.opts.user_info.id);c&&c()}))})},logout:function(a){var b=this;this.data.user.id&&this.save_user_data(this.data.user.cnv_id,!0,function(){b.data.ref_user.off();
b.data.ref_users.off();b.data.ref_msgs.off();b.data.ref.unauth();b.be_offline();b.trigger("logged_out",a)});this.minimize()},be_offline:function(){this.data.mode="offline";this.data.ref_user&&(this.data.ref_user.child("status").set("offline"),this.data.ref_user.child("last_online").set(Firebase.ServerValue.TIMESTAMP));this.check_mode(!0);this.trigger("offline")},check_user:function(a){var b=this;this.data.ref_user=this.data.ref_users.child(a);this.data.ref_user.once("value",function(c){(c=c.val())||
(c={});b.get_user(a,c)});this.data.ref_user.on("child_removed",function(a){(a=a.val())&&("online"!==b.data.mode||a.status||b.logout())})},get_user:function(a,b,c){var e=this;if(b.id)this.data.user=b,this.data.ref_user.child("status").set("online"),this.data.ref_user.child("ip").set(cx.ip),this.data.ref_user.child("current_page").set(cx.current_page),cx.user_name&&!cx.is_front_end&&(this.data.ref_user.child("name").set(cx.user_name),this.data.ref_user.child("email").set(cx.user_email),this.data.ref_user.child("gravatar").set(cx.user_email_hash)),
this.total_online_ops()?this.show_cnv():this.show_offline(),this.manage_conn(),e.trigger("logged_in",this.data.user),e.listen_users(),c&&c();else if(!0===this.data._new_user){b=this.data.ref_cnv.push({user_id:a,created_at:Firebase.ServerValue.TIMESTAMP});a={id:a,cnv_id:b.name(),ip:cx.ip,is_mobile:this.data.is_mobile,current_page:cx.current_page,type:cx.is_op?"operator":"visitor",status:"online"};for(var m in this.opts.user_info)a[m]=this.opts.user_info[m];for(m in this.data.current_form)a[m]=this.data.current_form[m];
a.name||(a.name=a.email?a.email.substring(0,a.email.indexOf("@")):this.opts.guest_prefix+this.random_id(1E3,5E3));this.data.user=a;cx.is_front_end&&e.opts.notify_by_email&&e.post("notify",e.data.user,function(a){e.log("Notify operators?",a)});this.data.ref_user.set(a,function(a){a?e.trigger("user_failed",a):(e.show_cnv(),e.trigger("user_created",e.data.user),e.trigger("logged_in",e.data.user),e.manage_conn(),e.listen_users());c&&c()})}else e.listen_users()},get_user_data:function(a,b){this.data.ref_users.child(a).once("value",
function(a){a=a.val();b(a)})},manage_conn:function(){var a=this;if(this.data.ref_user)this.data.ref_conn.on("value",function(b){!0===b.val()&&(a.data.ref_user.child("connections").push(!0).onDisconnect().remove(),a.data.ref_user.child("status").set("online"),a.data.ref_user.child("status").onDisconnect().set("offline"),a.data.ref_user.child("last_online").onDisconnect().set(Firebase.ServerValue.TIMESTAMP),a.data.ref_cnv.child(a.data.user.cnv_id+"/typing/"+a.data.user.id).onDisconnect().remove())})},
push_msg:function(a){this.data.ref_msgs.push({user_id:this.data.user.id,user_type:this.data.user.type,cnv_id:this.data.user.cnv_id,name:this.data.user.name||this.data.user.email,gravatar:this.data.user.gravatar,msg:a,time:Firebase.ServerValue.TIMESTAMP})},listen_new_msgs:function(a){var b=this,c=a?b.data.ref_msgs.startAt(null,a):b.data.ref_msgs,e=!0;a||(e=!1);c.on("child_added",function(a){var c=a.val();a=a.name();c.id=a;cx.is_front_end&&b.data.user.cnv_id==c.cnv_id&&(e||b.add_msg(c));e||b.show_popup();
b.trigger("new_msg",c);e=!1})},listen_msgs:function(){var a=this;this.data.ref_msgs.off();this.data.ref_msgs.once("value",function(b){var c=(b=b.val())?Object.keys(b).length:0,e=1;b?d.each(b,function(b,d){cx.is_front_end&&a.data.user.cnv_id==d.cnv_id&&(d.id=b,a.add_msg(d));d.first_load=!0;a.trigger("new_msg",d);c==e&&a.listen_new_msgs(b);e+=1}):a.listen_new_msgs()})},reload_cnv:function(a){var b=this;this.data.ref_msgs.once("value",function(c){var e=(c=c.val())?Object.keys(c).length:0,m=0,n=1;c?d.each(c,
function(c,d){d.cnv_id==a&&(d.old_msg=!0,b.trigger("new_msg",d),m+=1);e==n&&b.trigger("cnv_msgs_loaded",m);n+=1}):b.trigger("cnv_msgs_loaded",0)})},allow_chatbox:function(){return!this.opts.render||this.opts.disable_on_mobile&&this.data.is_mobile?!1:!0},render_btn:function(){var a=this;if(cx.is_front_end&&!this.data.embed){this.data.v_pos="n"==this.opts.gravity.charAt(0)?"top":"bottom";this.data.h_pos="e"==this.opts.gravity.charAt(1)?"right":"left";this.data.primary_fg=this.use_white(this.opts.colors.primary)?
"#ffffff":"#444444";this.data.link_fg=this.use_white(this.opts.colors.link)?"#ffffff":"#444444";this.data.primary_hover=this.shade_color(this.opts.colors.primary,7);this.data.link_hover=this.shade_color(this.opts.colors.link,7);switch(this.opts.trim_radius){case "h":this.data.radius=this.data.radius_f="0 0 "+this.opts.radius+" "+this.opts.radius;this.data.radius_h=0;break;case "f":this.data.radius=this.data.radius_h=this.opts.radius+" "+this.opts.radius+" 0 0";this.data.radius_f=0;break;default:this.data.radius=
this.opts.radius,this.data.radius_h=this.opts.radius+" "+this.opts.radius+" 0 0",this.data.radius_f="0 0 "+this.opts.radius}var b=this.opts.btn_view.show_icon?"":"cx-no-ico";this.opts.btn_view.show_title||(b+=" cx-no-title");this.el.html(this.render("btn",{box_id:this.data.box_id,title:this.opts.msg.online,"class":b,display_title:this.opts.btn_view.show_title?"block":"none",display_ico:this.opts.btn_view.show_icon?"block":"none",display_arr:this.opts.btn_view.show_arrow?"block":"none",color:this.data.primary_fg,
width:this.opts.btn_width||"",bg_color:this.opts.colors.primary,h_pos:this.data.h_pos,v_pos:this.data.v_pos,radius:this.data.radius,offset_x:this.opts.offset_x,offset_y:this.opts.offset_y,direction:"n"==this.opts.gravity.charAt(0)?"down":"up"}));this.objs.btn=d("#CX_btn_"+this.data.box_id);this.objs.btn.hover(function(){d(this).css("background-color",a.data.primary_hover)},function(){d(this).css("background-color",a.opts.colors.primary)});this.objs.btn.click(function(){var b=d(this),e=d(this).find(".cx-title");
e.html(a.opts.msg.please_wait+"...");b.hide();a.show_popup();a.auth(function(){e.html(a.opts.msg.online);0<a.opts.offline_redirect.length&&"offline"===a.data.mode&&(p.location.href=a.opts.offline_redirect)})});setTimeout(function(){a.show_btn()},this.opts.delay)}},render_popup:function(){var a=this;cx.is_front_end&&(this.el.append(this.render("popup",{box_id:this.data.box_id,title:this.opts.msg.connecting+"...","class":"connecting",h_pos:this.data.h_pos,v_pos:this.data.v_pos,offset_x:this.opts.offset_x,
offset_y:this.opts.offset_y,color:this.data.primary_fg,width:this.opts.popup_width,bg_color:this.opts.colors.primary,body_class:"cx-form cx-offline-form",direction:"n"==this.opts.gravity.charAt(0)?"up":"down",radius:this.data.radius,radius_h:this.data.radius_h,radius_f:this.data.radius_f,body:this.render("connecting",{lead:this.opts.msg.connecting+"..."})})),this.objs.popup=d("#CX_popup_"+this.data.box_id),this.objs.popup_header=d("#CX_popup_header_"+this.data.box_id),this.objs.popup_body=d("#CX_popup_body_"+
this.data.box_id),d(q).on("hover","#CX_send_btn_"+this.data.box_id,function(){d(this).css("background-color",a.data.link_hover)},function(){d(this).css("background-color",a.opts.colors.link)}),this.objs.popup_header.click(function(){a.be_offline();a.minimize()}),d(p).resize(function(){var b=q.documentElement,c=q.getElementsByTagName("body")[0],b=p.innerHeight||b.clientHeight||c.clientHeight,c=a.objs.popup_header.innerHeight(),e=parseInt(a.objs.popup.css("bottom"),10),m="online"===a.data.mode?370:
450;a.objs.popup_body.css("max-height",m<b?m:b-c-e)}).trigger("resize"))},show_btn:function(a){cx.is_front_end&&this.allow_chatbox()&&(this.objs.btn.show(),this.objs.btn.find(".cx-title").html(a),this.animate(this.objs.btn,this.opts.anim))},show_popup:function(){if("open"!=this.data.popup_status&&cx.is_front_end){var a=this;this.cookie("cx_widget_status","open");this.objs.popup.show();this.animate(this.objs.popup,this.opts.anim);setTimeout(function(){switch(a.data.mode){case "online":d("#CX_cnv_reply_"+
a.data.box_id).focus();"bottom"==a.opts.reply_pos&&a.objs.cnv.scrollTop(1E4);break;case "offline":case "login":d("#CX_popup_form_"+a.data.box_id+" .cx-line:first-child input").focus()}a.data.popup_status="open"},this.data.anim_delay)}},minimize:function(){this.objs.btn.find(".cx-ico-chat");this.cookie("cx_widget_status","minimized");this.data.popup_status="close";this.objs.popup&&this.objs.popup.hide();this.objs.btn.show();this.animate(this.objs.btn,this.opts.anim)},show_cnv:function(a){var b=this;
this.data.mode="online";cx.is_front_end&&this.allow_chatbox()&&(this.objs.popup_header.find(".cx-title").html(this.opts.msg.online),this.objs.popup.parent().removeClass().addClass("cx-online cx-reply-"+this.opts.reply_pos),this.objs.popup_body.removeClass().addClass("cx-body cx-online cx-reply-"+this.opts.reply_pos).empty().html(this.render("online-"+this.opts.reply_pos,{box_id:this.data.box_id,reply_ph:this.opts.msg.reply_ph,welc:this.opts.msg.welc_msg,end_chat:this.opts.msg.end_chat})),this.objs.cnv=
d("#CX_cnv_"+this.data.box_id),a?setTimeout(function(){d("#CX_cnv_reply_"+b.data.box_id).focus().autosize({append:""}).trigger("autosize.resize")},this.data.anim_delay):d("#CX_cnv_reply_"+b.data.box_id).focus().autosize({append:""}).trigger("autosize.resize"),d(p).trigger("resize"),this.listen_msgs(),d("#CX_tool_end_chat").click(function(){b.logout()}),this.manage_reply_box())},manage_reply_box:function(a){var b=this,c=!1,e=d("#CX_cnv_reply_"+this.data.box_id),m=function(){var a=0;return function(b,
c){clearTimeout(a);a=setTimeout(b,c)}}();this.data.ref_cnv.child(this.data.user.cnv_id+"/typing").remove();e.keydown(function(a){if(13!==a.keyCode||a.shiftKey){if(!c){switch(a.keyCode){case 17:case 18:case 16:case 9:case 8:case 224:case 17:case 91:case 93:return}b.data.ref_cnv.child(b.data.user.cnv_id+"/typing/"+b.data.user.id).set(b.data.user.name);c=!0}m(function(){b.data.ref_cnv.child(b.data.user.cnv_id+"/typing/"+b.data.user.id).remove();c=!1},1300)}else if(a.preventDefault(),a=d(this).val())d(this).val("").trigger("autosize.resize"),
b.push_msg(a),b.data.ref_cnv.child(b.data.user.cnv_id+"/typing/"+b.data.user.id).remove()});a&&this.data.ref_cnv.child(a+"/typing").off();this.data.ref_cnv.child(this.data.user.cnv_id+"/typing").on("value",function(a){var c=0,e=(a=a.val())?Object.keys(a).length:0;a?d.each(a,function(a,m){a&&a!==b.data.user.id?b.display_ntf(b.opts.msg.writing.replace(/%s/i,m),"typing"):(e===c&&b.clean_ntf(),c+=1)}):b.clean_ntf()});cx.is_front_end&&this.objs.popup.find(".cx-cnv-reply").click(function(){e.focus()})},
show_login:function(a,b){var c=this;cx.is_front_end&&this.allow_chatbox()&&(this.opts.display_login&&this.total_online_ops()&&this.objs.popup?(this.data.mode="login",this.objs.popup_header.find(".cx-title").html(this.opts.msg.online),this.objs.popup.parent().removeClass().addClass("cx-login"),this.objs.popup_body.removeClass().addClass("cx-body cx-form cx-login-form").empty().html(this.render("login",{box_id:this.data.box_id,lead:a||this.opts.msg.prechat_msg,form:this.get_form(this.opts.login_form),
btn:this.opts.msg.start_chat,btn_color:this.data.link_fg,btn_bg:this.opts.colors.link})),d(p).trigger("resize"),d("#CX_login_btn_"+this.data.box_id).hover(function(){d(this).css("background-color",c.data.link_hover)},function(){d(this).css("background-color",c.opts.colors.link)}),d("#CX_login_btn_"+this.data.box_id).click(function(){c.send_login_form()}),d("#CX_popup_form_"+this.data.box_id).keydown(function(a){13!=a.keyCode||a.shiftKey||(a.preventDefault(),c.send_login_form())})):"online"===c.data.mode?
this.show_cnv():this.show_offline(),b&&this.minimize())},send_login_form:function(){var a=this;this.display_ntf(this.opts.msg.connecting+"...","sending");var b=d("#CX_popup_form_"+this.data.box_id).serializeArray(),c=b.length-1;d.each(b,function(b,m){a.data.current_form[m.name]=m.value;if(a.opts.login_form[m.name].req){if(!m.value)return a.display_ntf(a.opts.msg.field_empty,"error"),!1;if("email"===a.opts.login_form[m.name].type)if(a.validate_email(m.value))a.data.current_form.gravatar=a.md5(m.value);
else return a.display_ntf(a.opts.msg.invalid_email,"error"),!1}b===c&&a.login(!0)})},show_connecting:function(){this.objs.popup_body.html(this.render("connecting",{lead:this.opts.msg.connecting+"..."}))},show_offline:function(){var a=this,b=!1;this.data.mode="offline";cx.is_front_end&&this.allow_chatbox()&&(this.objs.popup_header.find(".cx-title").html(this.opts.msg.offline),this.objs.popup.parent().removeClass().addClass("cx-offline"),this.objs.popup_body.removeClass().addClass("cx-body cx-form cx-offline-form").empty().html(this.render("offline",
{box_id:this.data.box_id,lead:this.opts.msg.offline_body,form:this.get_form(this.opts.offline_form),btn:this.opts.msg.send_btn,btn_color:this.data.link_fg,btn_bg:this.opts.colors.link})),d(p).trigger("resize"),d("#CX_send_btn_"+this.data.box_id).click(function(c){if(b)return!1;b=!0;a.display_ntf(a.opts.msg.sending+"...","sending");a.post("offline_form",d("#CX_popup_form_"+a.data.box_id).serialize(),function(c){b=!1;c.error?a.display_ntf(c.error,"error"):(a.display_ntf(c.msg,"success"),setTimeout(function(){a.clean_ntf();
a.minimize()},2E3))});return!1}))},total_online_ops:function(){return this.data.online_ops?Object.keys(this.data.online_ops).length:0},check_mode:function(a){if(cx.is_front_end){var b=this.data.mode;this.log("mode checking - online ops:",b,this.data.online_ops);this.log("Any OPERATOR?",this.total_online_ops());if(a)this.show_connecting(),this.data.mode="offline";else if(this.total_online_ops())"offline"===b&&(d("#CX_cnv_reply_"+this.data.box_id).removeClass("cx-disabled").removeAttr("disabled"),this.clean_ntf()),
this.data.mode=this.opts.display_login&&"online"!=b?"login":"online";else{switch(b){case "login":this.show_offline();break;case "online":this.opts.display_login?(d("#CX_cnv_reply_"+this.data.box_id).addClass("cx-disabled").attr("disabled","disabled"),this.display_ntf(this.opts.msg.no_op+"!","error")):this.show_offline()}this.data.mode="offline"}this.log("mode changed - online ops:",this.data.mode,this.data.online_ops)}},add_msg:function(a,b,c){var e=new Date,m=new Date(a.time),n=m.getHours()+":"+
(10>m.getMinutes()?"0":"")+m.getMinutes(),r=this.sanitize_msg(a.msg),e=m.toDateString()==e.toDateString()?n:m.getUTCDate()+" "+this.opts.msg.months_short[m.getUTCMonth()]+", "+n,l="operator"===a.user_type?!0:!1;chat_line=this.render("chat_line",{msg_id:a.id,time:e,date:m.getUTCDate()+" "+this.opts.msg.months[m.getUTCMonth()]+" "+m.getUTCFullYear()+" "+n,color:"transparent",avatar:'<img src="'+this.gravatar(a.gravatar,this.opts.avatar_size,l)+'" />',name:a.name,msg:r,"class":a.user_id==this.data.user.id?
" cx-you":""});cx.is_front_end&&this.objs.cnv.find(".cx-welc").hide();b==a.user_id&&"bottom"==this.opts.reply_pos?d("#CX_msg_"+c+" .cx-cnv-msg-detail").append('<span class="cx-cnv-xtra-msg cx-bottom">'+r+"</span>").scrollTop(1E4):this.objs.cnv&&("top"!=this.opts.reply_pos&&cx.is_front_end?this.objs.cnv.append(chat_line).scrollTop(1E4):this.objs.cnv.prepend(chat_line))},sanitize_msg:function(a){a=a.replace(/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,'<a href="$1" target="_blank">$1</a>');
a=a.replace(/(^|[^\/])(www\.[\S]+(\b|$))/gim,'$1<a href="http://$2" target="_blank">$2</a>');return a=a.replace(/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,'<a href="mailto:$1">$1</a>')},update_user:function(a,b){a&&!a.id?this.log("no user id"):(a&&(a.cnv_id?(this.log("user updated",a),this.add_user_item(a),"operator"===a.type&&("online"===a.status?this.data.online_ops[a.id]=a:delete this.data.online_ops[a.id],this.log("total ops updated",this.data.online_ops)),this.check_mode(),b||
this.trigger("user_online",a),cx.is_front_end||this.data.active_user_id!==a.id||d("#CX_active_page").attr("href",a.current_page).find("span").html(a.current_page)):this.clean_user_data(a.id)),this.data.last_changed_id=b)},add_user_item:function(a){if(a.id&&this.data.user_list){var b="offline"===a.status?' &bull; <span class="cx-last-online" data-time="'+a.last_online+'">'+this.timeago(a.last_online)+"</span>":"",c='<span class="cx-ico cx-ico-'+a.status+'"></span><span class="cx-ico cx-ico-'+a.type+
'"></span>';d("#CX_ls_usr_"+a.id).remove();a.is_mobile&&(c+=' <span class="cx-ico cx-ico-mobile"></span>');a={id:a.id,"class":"cx-user-"+a.status+" cx-user-"+a.type,icons:c,color:a.color||"transparent",username:a.name||a.email||"N/A",avatar:'<img src="'+this.gravatar(a.gravatar,this.opts.avatar_size,"operator"===a.type?!0:!1)+'" />',cnv_id:a.cnv_id,meta:a.type+b};this.data.user_list.append(this.render("user_item",a))}},remove_user_item:function(a){this.data.user_list&&d("#CX_ls_usr_"+a).remove()},
listen_new_users:function(a){var b=this;this.data.ref_users.on("value",function(a){d("#CX_users > ul").empty();a=a.val();d.each(a,function(a,c){b.update_user(c)})})},listen_users:function(){var a=this;this.data.last_changed_id=null;this.opts.users_list_id&&(d(this.opts.users_list_id+" > ul").remove(),d(this.opts.users_list_id).append("<ul></ul>"),this.data.user_list=d(this.opts.users_list_id+" > ul"));this.data.ref_users.once("value",function(b){b=b.val();var c=0;if(null!==b){var e=Object.keys(b).length;
a.data.online_ops={};d.each(b,function(b,d){c+=1;d&&("operator"===d.type&&("online"===d.status?a.data.online_ops[d.id]=d:delete a.data.online_ops[d.id],a.log("total ops updated",a.data.online_ops)),a.add_user_item(d));c===e&&(a.check_mode(),a.listen_new_users())})}})},save_user_data:function(a,b,c){var e=this;this.data.ref_cnv.child(a).once("value",function(m){var n=m.val();if(n){var r=n.user_id;e.data.ref_users.child(r).once("value",function(m){var p=m.val();p.cnv_time=n.created_at;e.data.ref_msgs.once("value",
function(m){var l=(m=m.val())?Object.keys(m).length:0,n=0,g={};m?d.each(m,function(d,m){n+=1;m.cnv_id===a&&(g[d]=m,b&&e.data.ref_msgs.child(d).remove());l===n&&(p.msgs=g,e.post("save_transcript",p,function(a){c&&c(a)}))}):c&&c({});b&&(e.data.ref_users.child(r).remove(),e.data.ref_cnv.child(a).remove())})})}})},clean_user_data:function(a){var b=this,c=this.data.ref_users.child(a);c.once("value",function(e){e=e.val();c.remove();e.cnv_id&&b.ref_cnv.child(e.cnv_id);b.data.ref_msgs.once("value",function(c){(c=
c.val())&&d.each(c,function(c,e){e.user_id===a&&b.data.ref_msgs.child(c).remove()})})})},get_form:function(a){var b=this,c="";d.each(a,function(a,d){var n={id:a+"_"+b.data.box_id,name:a,title:d.title,ph:d.title,type:d.type};1==d.req?n.after_label=' <span class="cx-req">*</span>':n.ph=n.ph+" ("+b.opts.msg.optional+")";if(cx.user_email)switch(a){case "name":n.val=cx.user_name;break;case "email":n.val=cx.user_email}switch(d.type){case "text":case "email":case "number":case "color":case "date":case "datetime":case "datetime-local":case "tel":case "time":case "url":case "week":case "search":var r=
"input";break;default:r=d.type}c+=b.render("form_"+r,n)});return c},update_geo:function(){var a=this;d.getJSON("http://ip-api.com/json/?callback=?",function(b){a.data.user.country=b.country;a.data.user.country_code=b.countryCode;a.data.user.city=b.city;a.data.user.IP=b.query;a.data.ref_user.update({country:b.country,country_code:b.countryCode,city:b.city,IP:b.query})})},random_id:function(a,b){return Math.floor(Math.random()*(b-a+1))+a},cookie:function(a,b,c){if(b||-1===c){if(c){var e=new Date;e.setTime(e.getTime()+
864E5*c);c="; expires="+e.toGMTString()}else c="";q.cookie=a+"="+b+c+"; path=/"}else{a+="=";b=q.cookie.split(";");for(c=0;c<b.length;c++){for(e=b[c];" "==e.charAt(0);)e=e.substring(1,e.length);if(0===e.indexOf(a))return e.substring(a.length,e.length)}return null}},remove_cookie:function(a){this.cookie(a,"",-1)},check_ntf:function(){"Notification"in p&&!cx.is_front_end&&"denied"!==Notification.permission&&Notification.requestPermission(function(a){"permission"in Notification||(Notification.permission=
a)})},notify:function(a,b,c,e){if(Notification&&!cx.is_front_end&&"Notification"in p&&!cx.is_front_end)if("granted"===Notification.permission){var d=new Notification(a,{body:b,icon:cx.plugin_url+"/assets/img/cx-ico-32.png",tag:e});c?d.onclick=function(){c()}:d.close();setTimeout(function(){d.close()},4E3)}else"denied"!==Notification.permission&&Notification.requestPermission(function(e){"permission"in Notification||(Notification.permission=e);if("granted"===e){var d=new Notification(a,{body:b});c?
d.onclick=function(){c()}:d.close();setTimeout(function(){d.close()},4E3)}})},time:function(a,b){return this.opts.msg.time[a]&&this.opts.msg.time[a].replace(/%d/i,Math.abs(Math.round(b)))},timeago:function(a){if(!a)return"";a=.001*((new Date).getTime()-a)>>0;var b=a/60,c=b/60,e=c/24,d=e/365;return(45>a&&this.time("seconds",a)||90>a&&this.time("minute",1)||45>b&&this.time("minutes",b)||90>b&&this.time("hour",1)||24>c&&this.time("hours",c)||42>c&&this.time("day",1)||30>e&&this.time("days",e)||45>e&&
this.time("month",1)||365>e&&this.time("months",e/30)||1.5>d&&this.time("year",1)||this.time("years",d))+" "+this.opts.msg.time.suffix},render:function(a,b){var c=[];switch(a){case "btn":c=['<div id="CX_btn_',b.box_id,'" style="display: none;color:',b.color,"; background-color:",b.bg_color,";width:",b.width,"px; ",b.h_pos,":",b.offset_x,";","; border-radius: ",b.radius,";",b.v_pos,":",b.offset_y,';" class="cx-chat-btn cx-online-btn ',b["class"],'"><div class="cx-ico cx-ico-chat" style="display:',
b.display_ico,'"></div><div class="cx-ico cx-ico-arrow-',b.direction,'" style="display:',b.display_arr,';"></div><div class="cx-title" style="display:',b.display_title,';">',b.title,"</div></div>"];break;case "popup":c=['<div id="CX_popup_',b.box_id,'" data-id="',b.box_id,'" class="cx-widget" style="display: none; width:',b.width,"px; ",b.h_pos,":",b.offset_x,";",b.v_pos,":",b.offset_y,";border-radius:"+b.radius+';"><div class="cx-',b["class"],'"><div id="CX_popup_header_',b.box_id,'" class="cx-header" style="border-radius:'+
b.radius_h+";background-color:",b.bg_color,"; color:",b.color,';"><div class="cx-title">',b.title,'</div><div class="cx-ico cx-ico-arrow-',b.direction,'"></div></div><div id="CX_popup_body_',b.box_id,'" class="cx-body ',b.body_class,'" style="border-radius:'+b.radius_f+';">',b.body,"</div></div>"];break;case "ntf":c=['<div class="cx-body cx-ntf-msg"><div class="cx-lead">',b.lead,"</div></div>"];break;case "connecting":c=['<div class="cx-body"><div class="cx-ntf cx-sending cx-conn">',b.lead,"</div></div>"];
break;case "login":c=['<div class="cx-lead">',b.lead,'</div><form id="CX_popup_form_',b.box_id,'" action="">',b.form,'<div class="cx-send"><div id="CX_popup_ntf_',b.box_id,'" class="cx-ntf"></div><a href="javascript:void(0)" id="CX_login_btn_',b.box_id,'" class="cx-form-btn" style="color:',b.btn_color,";background-color:",b.btn_bg,';" >',b.btn,"</a></div></form>"];break;case "online-top":c=['<div class="cx-cnv-reply"><div class="cx-cnv-input"><textarea id="CX_cnv_reply_',b.box_id,'" name="msg" class="cx-reply-input" placeholder="',
b.reply_ph,'"></textarea></div></div><div id="CX_popup_ntf_',b.box_id,'"></div><div class="cx-cnv" id="CX_cnv_',b.box_id,'"><div class="cx-welc">',b.welc,'</div></div><div class="cx-tools"><a id="CX_tool_end_chat" href="javascript:void(0)">',b.end_chat,"</a></div>"];break;case "online-bottom":c=['<div id="CX_popup_ntf_',b.box_id,'"></div><div class="cx-cnv" id="CX_cnv_',b.box_id,'"><div class="cx-welc">',b.welc,'</div></div><div class="cx-tools"><a id="CX_tool_end_chat" href="javascript:void(0)">',
b.end_chat,'</a></div><div class="cx-cnv-reply"><div class="cx-cnv-input"><textarea id="CX_cnv_reply_',b.box_id,'" name="msg" class="cx-reply-input" placeholder="',b.reply_ph,'"></textarea></div></div>'];break;case "online-basic":c=['<div class="cx-cnv-reply"><div class="cx-cnv-input"><textarea name="msg" class="cx-reply-input" id="CX_cnv_reply_',b.box_id,'" placeholder="',b.reply_ph,'"></textarea></div></div><div id="CX_popup_ntf_',b.box_id,'"></div><div id="CX_cnv_',b.box_id,'" class="cx-cnv-wrap"><div id="CX_load_msg_',
b.box_id,'" class="cx-load-msg">',b.load_msg,'</div></div><div id="CX_cnv_user_info_',b.box_id,'" class="cx-user-meta"></div>'];break;case "offline":c=['<div class="cx-lead">',b.lead,'</div><form id="CX_popup_form_',b.box_id,'" action="">',b.form,'<div class="cx-send"><div id="CX_popup_ntf_',b.box_id,'" class="cx-ntf"></div><a href="javascript:void(0)" id="CX_send_btn_',b.box_id,'" class="cx-form-btn" style="color:',b.btn_color,";background-color:",b.btn_bg,';" >',b.btn,"</a></div></form>"];break;
case "user_item":c=['<li id="CX_ls_usr_',b.id,'" data-id="',b.id,'" data-cnv-id="',b.cnv_id,'" data-name="',b.username,'" data-count="0" class="',b["class"],'"><div class="cx-avatar">',b.avatar,'</div><div class="cx-username">',b.username,' <span class="cx-count"></span>',b.icons,'</div><div class="cx-meta">',b.meta,"</div></li>"];break;case "chat_line":c=['<div id="CX_msg_',b.msg_id,'" class="cx-cnv-line ',b["class"],'"><div class="cx-avatar cx-img" style="background-color:',b.color,'">',b.avatar,
'</div><div class="cx-cnv-msg"><div title="',b.date,'" class="cx-cnv-time">',b.time,'</div><div class="cx-cnv-author">',b.name,':</div> <span class="cx-cnv-msg-detail">',b.msg,'</span></div></div><div class="cx-clear"></div>'];break;case "form_input":c=['<div class="cx-line"><label for="CX_field_',b.id,'"><span class="cx-title">',b.title,"</span> ",b.after_label,':</label><input type="',b.type,'" name="',b.name,'" id="CX_field_',b.id,'" placeholder="',b.ph,'" class="cx-field" value="',b.val,'"></div>'];
break;case "form_textarea":c=['<div class="cx-line"><label for="CX_field_',b.id,'"><span class="cx-title">',b.title,"</span> ",b.after_label,':</label><textarea id="CX_field_',b.id,'" name="',b.name,'" placeholder="',b.ph,'" class="cx-field">',b.val,"</textarea></div>"]}return c.join("")},trigger:function(a,b){if(!1===this.opts[a].call(this,b))return!1},display_ntf:function(a,b){d("#CX_popup_ntf_"+this.data.box_id).removeClass().addClass("cx-ntf cx-"+b).html(a).fadeIn(300)},clean_ntf:function(){d("#CX_popup_ntf_"+
this.data.box_id).html("").hide()},shade_color:function(a,b){var c=parseInt(a.slice(1),16),e=Math.round(2.55*b),d=(c>>16)+e,n=(c>>8&255)+e,c=(c&255)+e;return"#"+(16777216+65536*(255>d?1>d?0:d:255)+256*(255>n?1>n?0:n:255)+(255>c?1>c?0:c:255)).toString(16).slice(1)},use_white:function(a){a=a.substring(1);a=parseInt(a,16);return 180>.2126*(a>>16&255)+.7152*(a>>8&255)+.0722*(a>>0&255)?!0:!1},escape_html:function(a){var b=this.data.entity_map;return String(a).replace(/[&<>"'\/]/g,function(a){return b[a]})},
play_sound:function(a){function b(a,b){d("<source>").attr("src",b).appendTo(a)}var c=d("<audio />",{autoPlay:"autoplay"});b(c,cx.plugin_url+"/assets/sounds/"+a+".mp3");b(c,cx.plugin_url+"/assets/sounds/"+a+".ogg");b(c,cx.plugin_url+"/assets/sounds/"+a+".wav");c.appendTo("body")},animate:function(a,b){d(p).trigger("resize");var c="n"==this.opts.gravity.charAt(0)?"Down":"Up";this.opts.speed_up?a.addClass("cx-"+b+c+" cx-anim"):a.addClass("cx-"+b+c+" cx-anim cx-hinge");setTimeout(function(){a.removeClass("cx-anim cx-hinge cx-"+
b+c)},this.data.anim_delay)},post:function(a,b,c){d.post(cx.ajax_url+"?action=cx_ajax_callback&mode="+a,b,c,"json").fail(function(b){console.log(a,": ",b);return!1})},log:function(a,b){this.opts.debug&&console.log(a,b)},validate_email:function(a){return/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(a)},md5:function(a){function b(a,b){var c,d,e,g,f;e=a&2147483648;g=b&2147483648;c=a&1073741824;
d=b&1073741824;f=(a&1073741823)+(b&1073741823);return c&d?f^2147483648^e^g:c|d?f&1073741824?f^3221225472^e^g:f^1073741824^e^g:f^e^g}function c(a,c,d,e,g,f,h){a=b(a,b(b(c&d|~c&e,g),h));return b(a<<f|a>>>32-f,c)}function d(a,c,e,g,f,h,k){a=b(a,b(b(c&g|e&~g,f),k));return b(a<<h|a>>>32-h,c)}function m(a,c,d,e,g,f,h){a=b(a,b(b(c^d^e,g),h));return b(a<<f|a>>>32-f,c)}function n(a,c,d,e,g,f,h){a=b(a,b(b(d^(c|~e),g),h));return b(a<<f|a>>>32-f,c)}function p(a){var b="",c="",d;for(d=0;3>=d;d++)c=a>>>8*d&255,
c="0"+c.toString(16),b+=c.substr(c.length-2,2);return b}var l=[],q,s,t,u,g,f,h,k;a=function(a){a=a.replace(/\r\n/g,"\n");for(var b="",c=0;c<a.length;c++){var d=a.charCodeAt(c);128>d?b+=String.fromCharCode(d):(127<d&&2048>d?b+=String.fromCharCode(d>>6|192):(b+=String.fromCharCode(d>>12|224),b+=String.fromCharCode(d>>6&63|128)),b+=String.fromCharCode(d&63|128))}return b}(a);l=function(a){var b,c=a.length;b=c+8;for(var d=16*((b-b%64)/64+1),e=Array(d-1),g=0,f=0;f<c;)b=(f-f%4)/4,g=f%4*8,e[b]|=a.charCodeAt(f)<<
g,f++;b=(f-f%4)/4;e[b]|=128<<f%4*8;e[d-2]=c<<3;e[d-1]=c>>>29;return e}(a);g=1732584193;f=4023233417;h=2562383102;k=271733878;for(a=0;a<l.length;a+=16)q=g,s=f,t=h,u=k,g=c(g,f,h,k,l[a+0],7,3614090360),k=c(k,g,f,h,l[a+1],12,3905402710),h=c(h,k,g,f,l[a+2],17,606105819),f=c(f,h,k,g,l[a+3],22,3250441966),g=c(g,f,h,k,l[a+4],7,4118548399),k=c(k,g,f,h,l[a+5],12,1200080426),h=c(h,k,g,f,l[a+6],17,2821735955),f=c(f,h,k,g,l[a+7],22,4249261313),g=c(g,f,h,k,l[a+8],7,1770035416),k=c(k,g,f,h,l[a+9],12,2336552879),
h=c(h,k,g,f,l[a+10],17,4294925233),f=c(f,h,k,g,l[a+11],22,2304563134),g=c(g,f,h,k,l[a+12],7,1804603682),k=c(k,g,f,h,l[a+13],12,4254626195),h=c(h,k,g,f,l[a+14],17,2792965006),f=c(f,h,k,g,l[a+15],22,1236535329),g=d(g,f,h,k,l[a+1],5,4129170786),k=d(k,g,f,h,l[a+6],9,3225465664),h=d(h,k,g,f,l[a+11],14,643717713),f=d(f,h,k,g,l[a+0],20,3921069994),g=d(g,f,h,k,l[a+5],5,3593408605),k=d(k,g,f,h,l[a+10],9,38016083),h=d(h,k,g,f,l[a+15],14,3634488961),f=d(f,h,k,g,l[a+4],20,3889429448),g=d(g,f,h,k,l[a+9],5,568446438),
k=d(k,g,f,h,l[a+14],9,3275163606),h=d(h,k,g,f,l[a+3],14,4107603335),f=d(f,h,k,g,l[a+8],20,1163531501),g=d(g,f,h,k,l[a+13],5,2850285829),k=d(k,g,f,h,l[a+2],9,4243563512),h=d(h,k,g,f,l[a+7],14,1735328473),f=d(f,h,k,g,l[a+12],20,2368359562),g=m(g,f,h,k,l[a+5],4,4294588738),k=m(k,g,f,h,l[a+8],11,2272392833),h=m(h,k,g,f,l[a+11],16,1839030562),f=m(f,h,k,g,l[a+14],23,4259657740),g=m(g,f,h,k,l[a+1],4,2763975236),k=m(k,g,f,h,l[a+4],11,1272893353),h=m(h,k,g,f,l[a+7],16,4139469664),f=m(f,h,k,g,l[a+10],23,3200236656),
g=m(g,f,h,k,l[a+13],4,681279174),k=m(k,g,f,h,l[a+0],11,3936430074),h=m(h,k,g,f,l[a+3],16,3572445317),f=m(f,h,k,g,l[a+6],23,76029189),g=m(g,f,h,k,l[a+9],4,3654602809),k=m(k,g,f,h,l[a+12],11,3873151461),h=m(h,k,g,f,l[a+15],16,530742520),f=m(f,h,k,g,l[a+2],23,3299628645),g=n(g,f,h,k,l[a+0],6,4096336452),k=n(k,g,f,h,l[a+7],10,1126891415),h=n(h,k,g,f,l[a+14],15,2878612391),f=n(f,h,k,g,l[a+5],21,4237533241),g=n(g,f,h,k,l[a+12],6,1700485571),k=n(k,g,f,h,l[a+3],10,2399980690),h=n(h,k,g,f,l[a+10],15,4293915773),
f=n(f,h,k,g,l[a+1],21,2240044497),g=n(g,f,h,k,l[a+8],6,1873313359),k=n(k,g,f,h,l[a+15],10,4264355552),h=n(h,k,g,f,l[a+6],15,2734768916),f=n(f,h,k,g,l[a+13],21,1309151649),g=n(g,f,h,k,l[a+4],6,4149444226),k=n(k,g,f,h,l[a+11],10,3174756917),h=n(h,k,g,f,l[a+2],15,718787259),f=n(f,h,k,g,l[a+9],21,3951481745),g=b(g,q),f=b(f,s),h=b(h,t),k=b(k,u);return(p(g)+p(f)+p(h)+p(k)).toLowerCase()},gravatar:function(a,b,c){return"https://www.gravatar.com/avatar/"+a+".jpg?s="+(b||80)+"&d="+(c?this.opts.company_avatar:
cx.plugin_url+"/assets/img/default-avatar.png")},uniqid:function(a,b){"undefined"===typeof a&&(a="");var c,d=function(a,b){a=parseInt(a,10).toString(16);return b<a.length?a.slice(a.length-b):b>a.length?Array(1+(b-a.length)).join("0")+a:a};this.php_js||(this.php_js={});this.php_js.uniqidSeed||(this.php_js.uniqidSeed=Math.floor(123456789*Math.random()));this.php_js.uniqidSeed++;c=a+d(parseInt((new Date).getTime()/1E3,10),8);c+=d(this.php_js.uniqidSeed,5);b&&(c+=(10*Math.random()).toFixed(8).toString());
return c}};d.fn.cx=function(a){var b,c;this.data("plugin_cx")instanceof s||this.data("plugin_cx",new s(this));c=this.data("plugin_cx");c.el=this;if("undefined"===typeof a||"object"===typeof a)"function"===typeof c.init&&c.init(a);else{if("string"===typeof a&&"function"===typeof c[a])return b=Array.prototype.slice.call(arguments,1),c[a].apply(c,b);d.error("Method "+a+" does not exist on jQuery.cx")}}})(jQuery,window,document);